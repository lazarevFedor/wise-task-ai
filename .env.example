# Copy this file to .env and adjust values as needed

# Optional API protection for ingest-api
API_KEY=your_secret_key_here

# Qdrant collection/config
COLLECTION_NAME=latex_books
QDRANT_HOST=qdrant
QDRANT_PORT=6333
QDRANT_GRPC_PORT=6334

# Embedding model configuration
EMBEDDING_MODEL=sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2
VECTOR_SIZE=384
VECTOR_DISTANCE=cosine

# Chunking configuration (used by indexer)
# CHUNK_MIN_LEN — минимальная длина чанка (символы)
# CHUNK_MAX_LEN — максимальная длина исходного чанка
# CHUNK_OVERLAP — перекрытие между соседними чанками (символы)
CHUNK_MIN_LEN=200
CHUNK_MAX_LEN=3500
CHUNK_OVERLAP=250

# Примечание:
# 1) После изменения CHUNK_* нужно переиндексировать:
#    docker compose run --rm indexer python main.py --recreate --batch-size 64
# 2) Для длинных ответов без переиндексации можно увеличить max_chars
#    и параметры сшивания в /v1/search: stitch_before/stitch_after.

# Search defaults (used by ingest-api); можно не задавать — есть дефолты
# SEARCH_MAX_CHARS — ограничение длины текста в ответе /v1/search
# SEARCH_WITH_CHUNK_TEXT — использовать исходный chunk_text (true/false)
# SEARCH_INCLUDE_DEBUG — включать диагностические поля (true/false)
# SEARCH_STITCH_NEIGHBORS — сшивать соседние чанки (true/false)
# SEARCH_STITCH_BEFORE — сколько чанков брать до хита
# SEARCH_STITCH_AFTER — сколько чанков брать после хита
# SEARCH_STITCH_USE_CHUNK_TEXT — для сшивания использовать chunk_text (true/false)
# SEARCH_DEFAULT_LIMIT — дефолтное число результатов
# SEARCH_INTERNAL_MULT / MIN / MAX — размер внутреннего пула кандидатов для гибридного ранжирования
SEARCH_MAX_CHARS=5000
SEARCH_WITH_CHUNK_TEXT=false
SEARCH_INCLUDE_DEBUG=false
SEARCH_STITCH_NEIGHBORS=true
SEARCH_STITCH_BEFORE=2
SEARCH_STITCH_AFTER=8
SEARCH_STITCH_USE_CHUNK_TEXT=true
SEARCH_DEFAULT_LIMIT=5
SEARCH_INTERNAL_MULT=18
SEARCH_INTERNAL_MIN=40
SEARCH_INTERNAL_MAX=220

# Scoring weights (WEIGHT_*) — тонкая настройка ранжирования (измените осторожно)
# VECTOR, LEX_MATCH, TITLE_MATCH, SOURCE_MATCH, APPROX_TITLE_HITS, FUZZY_TITLE_HITS,
# FUZZY_TEXT_HITS, ALGO_NAME_MATCH, DEF_BOOST, EXACT_SOURCE_MATCH, DEF_LIKE,
# HAS_PROPERTIES, HAS_LEMMA_THEOREM, BARYCENTER_FOCUS, BARY_BONUS, BARY_MISS_PENALTY,
# BOILERPLATE_PENALTY, EARLY_CHUNK_BONUS, IS_DEFINITION_FLAG, HAS_MATH_FLAG,
# ALGO_NAME_PAYLOAD_MATCH, IS_ALGORITHM_FLAG
WEIGHT_VECTOR=1.0
WEIGHT_LEX_MATCH=0.50
WEIGHT_TITLE_MATCH=0.90
WEIGHT_SOURCE_MATCH=0.40
WEIGHT_APPROX_TITLE_HITS=0.55
WEIGHT_FUZZY_TITLE_HITS=0.60
WEIGHT_FUZZY_TEXT_HITS=0.35
WEIGHT_ALGO_NAME_MATCH=1.80
WEIGHT_DEF_BOOST=0.70
WEIGHT_EXACT_SOURCE_MATCH=2.20
WEIGHT_DEF_LIKE=0.90
WEIGHT_HAS_PROPERTIES=0.55
WEIGHT_HAS_LEMMA_THEOREM=0.35
WEIGHT_BARYCENTER_FOCUS=0.60
WEIGHT_BARY_BONUS=3.5
WEIGHT_BARY_MISS_PENALTY=-2.2
WEIGHT_BOILERPLATE_PENALTY=-1.10
WEIGHT_EARLY_CHUNK_BONUS=0.45
WEIGHT_IS_DEFINITION_FLAG=1.10
WEIGHT_HAS_MATH_FLAG=0.35
WEIGHT_ALGO_NAME_PAYLOAD_MATCH=0.60
WEIGHT_IS_ALGORITHM_FLAG=0.40
WEIGHT_TITLE_PHRASE=1.40
WEIGHT_TEXT_PHRASE=0.60

# Caps / thresholds
TH_LEX_MATCH_CAP=6
TH_APPROX_TITLE_HITS_CAP=3
TH_FUZZY_TITLE_CAP=2
TH_FUZZY_TEXT_CAP=3
TH_EARLY_CHUNK_INDEX=3

# RAG (/v1/rag) defaults
# RAG_DEFAULT_LIMIT — число цитируемых фрагментов
# RAG_CONTEXT_CHARS — целевой размер собранного контекста
# RAG_INCLUDE_SOURCES — вернуть список источников
# RAG_WITH_CHUNK_TEXT — использовать полный chunk_text вместо display text
# RAG_INCLUDE_DEBUG — включить диагностические метаданные
# RAG_MIN_TERM_HITS — минимальные точные совпадения токенов для фильтра
# RAG_DIVERSIFY — включить MMR-диверсификацию
# RAG_MMR_LAMBDA — баланс (0..1) релевантность vs разнообразие
# RAG_INTERNAL_CANDIDATES — принудительное число внутренних кандидатов (иначе динамика)
# RAG_INTERNAL_MULT/MIN/MAX — параметры увеличения пула
# RAG_STITCH_NEIGHBORS / BEFORE / AFTER / USE_CHUNK_TEXT — логика сшивания соседей
RAG_DEFAULT_LIMIT=10
RAG_CONTEXT_CHARS=5000    
RAG_INCLUDE_SOURCES=true
RAG_WITH_CHUNK_TEXT=false
RAG_INCLUDE_DEBUG=false
RAG_MIN_TERM_HITS=0
RAG_DIVERSIFY=true
RAG_MMR_LAMBDA=0.7
# (оставьте пустым для автоподбора) RAG_INTERNAL_CANDIDATES=
RAG_INTERNAL_MULT=24
RAG_INTERNAL_MIN=60
RAG_INTERNAL_MAX=240
RAG_STITCH_NEIGHBORS=true
RAG_STITCH_BEFORE=2
RAG_STITCH_AFTER=6
RAG_STITCH_USE_CHUNK_TEXT=true
#Phrase extraction (generic n-gram based, optional overrides)
PHRASE_MAX_NGRAM=4      
#PHRASE_MIN_LEN=6      
# PHRASE_STOPWORDS=пример,стопслово  # дополнительные стоп-слова (через запятую)
